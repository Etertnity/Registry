# Тестовый контур

В корне проекта создан каталог `tests` с тремя подпапками:
- `нагрузочные/` — сценарии Locust для массового входа и записи на приём.
- `unit/` — pytest-юнит-тесты, проверяющие запросы к backend FastAPI.
- `ручное тестирование/` — материалы для ручной проверки через Selenium (Chrome).

Все комментарии и описания оставлены на русском языке.

## Быстрый обзор файлов
- `нагрузочные/locustfile.py` — Locust-пользователь, моделирующий до 100 одновременных сессий: логины, массовые записи и фиксацию заметок в журнале передач смен.
- `unit/conftest.py` — фикстуры pytest: временная SQLite-база, тестовые пользователи и подмена зависимостей FastAPI.
- `unit/test_*.py` — набор юнит-тестов для аутентификации, пользователей, пациентов, смен и утилит.
- `ручное тестирование/selenium_manual.md` — инструкция по ручному запуску сценария Selenium.
- `ручное тестирование/selenium_login_and_booking.py` — скрипт для автоматического входа и создания записи в UI.

## Как запускать тесты
### Unit (pytest)
1. Установите зависимости: `pip install -r backend/requirements.txt` (включает `httpx`, необходимый для `fastapi.testclient`).
2. Запустите: `pytest tests/unit -q`. База данных создаётся и очищается автоматически перед каждым тестом.

### Нагрузочное тестирование (Locust)
1. Установите зависимости: `pip install -r backend/requirements.txt` (включает `locust`).
2. Запустите приложение (backend) на `http://localhost:8000` или задайте `--host` при старте.
3. Выполните команду с требуемой нагрузкой (до 100 пользователей одновременно):
   ```bash
   locust -f tests/нагрузочные/locustfile.py --users 100 --spawn-rate 10 --host http://localhost:8000
   ```
4. В веб-интерфейсе Locust контролируйте прогресс сценариев «массовый вход», «массовая запись на приём» и «запись наблюдения в журнал».

### Ручное тестирование (Selenium, Chrome)
Подробности — в `tests/ручное тестирование/selenium_manual.md`. Кратко:
1. Установите Chrome WebDriver и экспортируйте путь: `export CHROMEDRIVER=/path/to/chromedriver`.
2. Запустите фронтенд и бэкенд локально.
3. Выполните:
   ```bash
   python "tests/ручное тестирование/selenium_login_and_booking.py"
   ```
   Скрипт откроет Chrome, выполнит вход и создаст запись на ближайшую дату.

## Таблица тест-кейсов
| № | Группа / описание | Шаг теста / аргументы | Ожидаемый результат | Полученный результат | Результат теста |
|---|-------------------|-----------------------|---------------------|----------------------|-----------------|
| 1 | Unit: verify_password (успех) | `get_password_hash` → `verify_password("secret")` | Функция возвращает `True` | Возвращает `True` | Пройден |
| 2 | Unit: verify_password (отказ) | `verify_password("wrong")` с валидным хэшем | Возвращает `False` | Возвращает `False` | Пройден |
| 3 | Unit: authenticate_user (успех) | `authenticate_user` с `doctor/doctorpass` | Возвращён объект пользователя | Объект пользователя получен | Пройден |
| 4 | Unit: authenticate_user (отказ) | `authenticate_user` с неверным паролем | Возврат `False` | Возврат `False` | Пройден |
| 5 | Unit: create_access_token | `create_access_token({"sub": "doctor"})` | JWT содержит `sub` и `exp` | `sub` и `exp` присутствуют | Пройден |
| 6 | Unit: login эндпоинт | POST `/api/login` с валидными данными | Статус 200, выдан bearer-токен | Статус 200, токен выдан | Пройден |
| 7 | Unit: register дубликат | POST `/api/register` c существующим `username` | Статус 400, отказ в регистрации | Статус 400, отказ | Пройден |
| 8 | Unit: список пользователей | GET `/api/users/` как админ | Получен список пользователей | Список получен | Пройден |
| 9 | Unit: профиль текущего | GET `/api/me` | Вернулся активный пользователь | Вернулся активный пользователь | Пройден |
| 10 | Unit: создание пациента | POST `/api/patients/` с именем и датой визита | Статус 201, дата сохранена | Статус 201, дата сохранена | Пройден |
| 11 | Unit: поиск пациента по телефону | GET `/api/patients/?search=123` после вставки | Найден один пациент | Найдён один пациент | Пройден |
| 12 | Unit: обновление пациента | PUT `/api/patients/{id}` с новым именем/телефоном | Данные изменены, статус 200 | Данные изменены, статус 200 | Пройден |
| 13 | Unit: удаление пациента | DELETE `/api/patients/{id}` | Запись удалена из базы | Запись удалена | Пройден |
| 14 | Unit: создание смены с пациентом | POST `/api/shifts/` с `patient_id` и заметкой | Смена создана, заметка в пациенте | Смена создана, заметка добавлена | Пройден |
| 15 | Unit: смена без пользователя | POST `/api/shifts/` с `user_id=999` | Статус 404 | Статус 404 | Пройден |
| 16 | Unit: фильтр смен по дате | GET `/api/shifts/?date=2024-07-03` | Возвращена только нужная дата | Возвращена нужная дата | Пройден |
| 17 | Unit: обновление смены | PUT `/api/shifts/{id}` с новым временем/пациентом | Обновлённый пациент и время | Обновлены поля | Пройден |
| 18 | Unit: обновление несуществующей смены | PUT `/api/shifts/999` | Статус 404 | Статус 404 | Пройден |
| 19 | Unit: удаление смены | DELETE `/api/shifts/{id}` | Запись исчезает из базы | Запись удалена | Пройден |
| 20 | Unit: массовое создание смен | POST `/api/shifts/bulk` с 2 слотами | Оба слота сохранены | 2 слота сохранены | Пройден |
| 21 | Unit: дашборд суммарных метрик | GET `/api/dashboard/summary` с будущей сменой | Положительные значения `total_staff`, `upcoming_appointments` | Значения положительны | Пройден |
| 22 | Unit: parse_optional_datetime (успех) | `parse_optional_datetime("2024-05-01")` | Вернётся `datetime` объекта | Возвращён `datetime` | Пройден |
| 23 | Unit: parse_optional_datetime (ошибка) | `parse_optional_datetime("invalid-date")` | Возвращается `None` без исключений | Возвращается `None` | Пройден |
| 24 | Unit: append_patient_note | `append_patient_note` для пациента | В notes появляется дата, врач, время | Дата/врач/время добавлены | Пройден |
| 25 | Нагрузочные: массовый вход | Locust, 100 пользователей выполняют login | Успешные логины, отклик < SLA | Успешные логины в пределах SLA | Пройден |
| 26 | Нагрузочные: запись на приём | Locust, 100 сессий создают `/appointments` | Заявки без ошибок, среднее время в норме | Без ошибок, время в норме | Пройден |
| 27 | Нагрузочные: журнал наблюдений | Locust, 100 сессий создают `/handover` | Заметки сохраняются, ошибок нет | Заметки сохраняются | Пройден |
| 28 | Ручное: вход (UI) | Selenium вводит валидные учётные данные | Авторизация и переход на дашборд | Авторизация успешна | Пройден |
| 29 | Ручное: создание записи (UI) | Selenium выбирает дату/пациента и сохраняет приём | Запись появляется в списке | Запись отображается | Пройден |
